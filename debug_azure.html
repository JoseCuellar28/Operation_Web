<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>DEBUG LOGIN - Operation Smart (v2)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        .card {
            width: 100%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status {
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .success {
            color: green;
            background: #d4edda;
        }

        .error {
            color: red;
            background: #f8d7da;
        }

        pre {
            text-align: left;
            font-size: 0.8em;
            background: #eee;
            padding: 5px;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <div class="card p-4">
        <h3 class="text-center mb-2">üîê Debug Login (Azure v2)</h3>
        <p class="text-center text-muted mb-4">Correcci√≥n de Protocolo JSON</p>

        <div class="mb-3">
            <label>API URL (Fija):</label>
            <input type="text" class="form-control" value="https://operationweb-api-815a0eaa.azurewebsites.net" readonly
                id="apiUrl">
        </div>

        <div class="mb-3">
            <label>Usuario</label>
            <input type="text" class="form-control" id="username" value="admin">
        </div>

        <div class="mb-3">
            <label>Contrase√±a</label>
            <input type="password" class="form-control" id="password" value="Prueba123">
        </div>

        <div class="d-flex gap-2 mb-3">
            <button onclick="pingServer()" class="btn btn-outline-secondary w-50">üì° Ping</button>
            <button onclick="testLogin()" class="btn btn-primary w-50">üîë Probar Login</button>
        </div>

        <div id="result" class="status text-center mt-3 d-none"></div>
    </div>

    <script>
        function log(msg, type = 'info', details = null) {
            const div = document.getElementById('result');
            div.classList.remove('d-none', 'success', 'error');
            div.className = `status text-center mt-3 ${type}`;

            let html = `<div>${msg}</div>`;
            if (details) {
                html += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            div.innerHTML = html;
        }

        async function pingServer() {
            const apiUrl = document.getElementById('apiUrl').value;
            log('‚è≥ Pinging Server...');
            try {
                const res = await fetch(`${apiUrl}/api/auth/ping`);
                if (res.ok) log('‚úÖ Server Activado y Respondiendo', 'success');
                else log(`‚ö†Ô∏è Server respondi√≥: ${res.status}`, 'error');
            } catch (e) {
                log('‚õî Error de conexi√≥n (Ping)', 'error', e.message);
            }
        }

        async function testLogin() {
            const apiUrl = document.getElementById('apiUrl').value;
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            log('‚è≥ Enviando Login...');

            const payload = {
                Username: username,    // CORREGIDO (Antes era dni)
                Password: password,     // PascalCase para asegurar match
                CaptchaId: "bypass",
                CaptchaAnswer: "9999",
                Platform: "web"
            };

            try {
                const response = await fetch(`${apiUrl}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const text = await response.text();
                let data = {};
                try { data = JSON.parse(text); } catch { }

                if (response.ok) {
                    log(`‚úÖ ¬°LOGIN EXITOSO!`, 'success', data);
                } else {
                    log(`‚ùå Error ${response.status}`, 'error', data.message || text || data);
                }
            } catch (error) {
                log(`‚õî Error de Red/Fetch`, 'error', error.message);
            }
        }
    </script>

</body>

</html>