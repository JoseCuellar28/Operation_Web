<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Verify CRUD Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../frontend/Modelo_Funcional/js/ui-components.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>

<body>
    <div id="results"></div>

    <script type="module">
        import '../frontend/Modelo_Funcional/js/dashboard_moderno.js';

        async function runTest() {
            await new Promise(r => setTimeout(r, 1000));

            const results = document.getElementById('results');
            function log(msg, success) {
                results.innerHTML += `<div style="color: ${success ? 'green' : 'red'}">${msg}</div>`;
            }

            // Mock Data
            window.dashboard.todosLosEmpleados = [
                { dni: '12345678', inspector: 'TEST USER', telefono: '999', distrito: 'LIMA', tipo: 'OPERARIO', estado: 'ACTIVO' }
            ];

            // Test 1: Open Create Modal
            try {
                window.dashboard.abrirModalCrearColaborador();
                const modal = document.getElementById('modal-colaborador');
                if (modal && modal.innerHTML.includes('Nuevo Colaborador')) {
                    log('Create Modal Opened Successfully', true);
                    window.dashboard.closeModal('modal-colaborador');
                } else {
                    log('Create Modal Failed to Open', false);
                }
            } catch (e) { log('Error opening create modal: ' + e.message, false); }

            // Test 2: Open Edit Modal
            try {
                window.dashboard.editarEmpleado('12345678');
                const modal = document.getElementById('modal-colaborador');
                const input = document.getElementById('colab-nombre');
                if (modal && input && input.value === 'TEST USER') {
                    log('Edit Modal Opened with Correct Data', true);
                    window.dashboard.closeModal('modal-colaborador');
                } else {
                    log('Edit Modal Failed or Data Missing', false);
                }
            } catch (e) { log('Error opening edit modal: ' + e.message, false); }

            // Test 3: Delete (Mock Confirm & Fetch)
            const originalConfirm = window.confirm;
            const originalFetch = window.fetch;
            window.confirm = () => true;
            let deleteCalled = false;
            window.fetch = async (url, options) => {
                if (url.includes('/api/personal/12345678') && options.method === 'DELETE') {
                    deleteCalled = true;
                    return { ok: true };
                }
                return { ok: true, json: async () => [] };
            };

            try {
                await window.dashboard.eliminarEmpleado('12345678');
                if (deleteCalled) log('Delete Action Called API Correctly', true);
                else log('Delete Action Failed to Call API', false);
            } catch (e) { log('Error deleting: ' + e.message, false); }

            // Restore
            window.confirm = originalConfirm;
            window.fetch = originalFetch;
        }

        runTest();
    </script>
</body>

</html>