<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba API - Gesti√≥n de Cuadrillas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .endpoint-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        .endpoint-title {
            background-color: #007bff;
            color: white;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            border-radius: 5px 5px 0 0;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #218838;
        }
        .response {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Prueba API - Gesti√≥n de Cuadrillas</h1>
        <p><strong>URL Base:</strong> <span id="baseUrl">http://localhost:5132/api</span></p>
        <p><strong>Estado de la API:</strong> <span id="apiStatus">Verificando...</span></p>
    </div>

    <!-- Endpoints de Cuadrillas -->
    <div class="container">
        <h2>üìã Endpoints de Cuadrillas</h2>
        
        <div class="endpoint-section">
            <div class="endpoint-title">GET /api/cuadrillas - Obtener todas las cuadrillas</div>
            <button onclick="getCuadrillas()">Probar</button>
            <div id="cuadrillas-response" class="response"></div>
        </div>

        <div class="endpoint-section">
            <div class="endpoint-title">GET /api/cuadrillas/{id} - Obtener cuadrilla por ID</div>
            <input type="number" id="cuadrilla-id" placeholder="ID de la cuadrilla" value="1">
            <button onclick="getCuadrillaById()">Probar</button>
            <div id="cuadrilla-by-id-response" class="response"></div>
        </div>

        <div class="endpoint-section">
            <div class="endpoint-title">GET /api/cuadrillas/estado/{estado} - Obtener cuadrillas por estado</div>
            <input type="text" id="cuadrilla-estado" placeholder="Estado (Activa/Inactiva)" value="Activa">
            <button onclick="getCuadrillasByEstado()">Probar</button>
            <div id="cuadrillas-estado-response" class="response"></div>
        </div>

        <div class="endpoint-section">
            <div class="endpoint-title">POST /api/cuadrillas - Crear nueva cuadrilla</div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="nueva-cuadrilla-nombre" placeholder="Nombre de la cuadrilla" value="Cuadrilla Test">
            </div>
            <div class="form-group">
                <label>Descripci√≥n:</label>
                <textarea id="nueva-cuadrilla-descripcion" placeholder="Descripci√≥n">Cuadrilla de prueba creada desde la API</textarea>
            </div>
            <div class="form-group">
                <label>Capacidad M√°xima:</label>
                <input type="number" id="nueva-cuadrilla-capacidad" placeholder="Capacidad m√°xima" value="5">
            </div>
            <div class="form-group">
                <label>Supervisor:</label>
                <input type="text" id="nueva-cuadrilla-supervisor" placeholder="Supervisor" value="Test Supervisor">
            </div>
            <div class="form-group">
                <label>Ubicaci√≥n:</label>
                <input type="text" id="nueva-cuadrilla-ubicacion" placeholder="Ubicaci√≥n" value="Zona Test">
            </div>
            <button onclick="createCuadrilla()">Crear Cuadrilla</button>
            <div id="create-cuadrilla-response" class="response"></div>
        </div>
    </div>

    <!-- Endpoints de Colaboradores -->
    <div class="container">
        <h2>üë• Endpoints de Colaboradores</h2>
        
        <div class="endpoint-section">
            <div class="endpoint-title">GET /api/colaboradores - Obtener todos los colaboradores</div>
            <button onclick="getColaboradores()">Probar</button>
            <div id="colaboradores-response" class="response"></div>
        </div>

        <div class="endpoint-section">
            <div class="endpoint-title">GET /api/colaboradores/{id} - Obtener colaborador por ID</div>
            <input type="number" id="colaborador-id" placeholder="ID del colaborador" value="1">
            <button onclick="getColaboradorById()">Probar</button>
            <div id="colaborador-by-id-response" class="response"></div>
        </div>

        <div class="endpoint-section">
            <div class="endpoint-title">GET /api/colaboradores/disponibles - Obtener colaboradores disponibles</div>
            <button onclick="getColaboradoresDisponibles()">Probar</button>
            <div id="colaboradores-disponibles-response" class="response"></div>
        </div>

        <div class="endpoint-section">
            <div class="endpoint-title">POST /api/colaboradores - Crear nuevo colaborador</div>
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="nuevo-colaborador-nombre" placeholder="Nombre" value="Test">
            </div>
            <div class="form-group">
                <label>Apellido:</label>
                <input type="text" id="nuevo-colaborador-apellido" placeholder="Apellido" value="Usuario">
            </div>
            <div class="form-group">
                <label>Documento:</label>
                <input type="text" id="nuevo-colaborador-documento" placeholder="Documento" value="99999999">
            </div>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="nuevo-colaborador-email" placeholder="Email" value="test.usuario@empresa.com">
            </div>
            <div class="form-group">
                <label>Tel√©fono:</label>
                <input type="text" id="nuevo-colaborador-telefono" placeholder="Tel√©fono" value="555-9999">
            </div>
            <div class="form-group">
                <label>Cargo:</label>
                <input type="text" id="nuevo-colaborador-cargo" placeholder="Cargo" value="T√©cnico">
            </div>
            <button onclick="createColaborador()">Crear Colaborador</button>
            <div id="create-colaborador-response" class="response"></div>
        </div>
    </div>

    <!-- Captcha Preview -->
    <div class="container">
        <h2>üîí Captcha</h2>
        <div class="endpoint-section">
            <div class="endpoint-title">GET /api/auth/captcha - Generar captcha (id + imagen base64)</div>
            <button onclick="getCaptcha()">Generar</button>
            <div style="display:flex; gap:15px; align-items:center; margin-top:10px;">
                <img id="captcha-img" alt="Captcha" style="height:40px; border:1px solid #ddd; border-radius:6px;">
                <button onclick="refreshCaptcha()">‚Üª Refrescar</button>
            </div>
            <div style="margin-top:10px;">
                <strong>Pregunta:</strong> <span id="captcha-question">(sin cargar)</span>
            </div>
            <div style="margin-top:10px;">
                <strong>Id:</strong> <span id="captcha-id">(sin cargar)</span>
            </div>
            <div style="margin-top:10px;">
                <strong>Imagen (endpoint directo):</strong> <a id="captcha-image-link" href="#" target="_blank">abrir</a>
            </div>
            <div id="captcha-response" class="response" style="margin-top:10px;"></div>
        </div>
    </div>

    <script>
        const baseUrl = localStorage.getItem('api_net') || 'http://localhost:5132/api';
        document.getElementById('baseUrl').textContent = baseUrl;

        // Verificar estado de la API
        async function checkApiStatus() {
            try {
                const response = await fetch(`${baseUrl}/cuadrillas`);
                if (response.ok) {
                    document.getElementById('apiStatus').textContent = '‚úÖ API funcionando correctamente';
                    document.getElementById('apiStatus').style.color = 'green';
                } else {
                    document.getElementById('apiStatus').textContent = '‚ùå API no responde correctamente';
                    document.getElementById('apiStatus').style.color = 'red';
                }
            } catch (error) {
                document.getElementById('apiStatus').textContent = '‚ùå Error de conexi√≥n con la API';
                document.getElementById('apiStatus').style.color = 'red';
            }
        }

        // Funci√≥n auxiliar para mostrar respuestas
        function displayResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = `response ${isError ? 'error' : 'success'}`;
        }

        // Endpoints de Cuadrillas
        async function getCuadrillas() {
            try {
                const response = await fetch(`${baseUrl}/cuadrillas`);
                const data = await response.json();
                displayResponse('cuadrillas-response', data, !response.ok);
            } catch (error) {
                displayResponse('cuadrillas-response', { error: error.message }, true);
            }
        }

        async function getCuadrillaById() {
            const id = document.getElementById('cuadrilla-id').value;
            try {
                const response = await fetch(`${baseUrl}/cuadrillas/${id}`);
                const data = await response.json();
                displayResponse('cuadrilla-by-id-response', data, !response.ok);
            } catch (error) {
                displayResponse('cuadrilla-by-id-response', { error: error.message }, true);
            }
        }

        async function getCuadrillasByEstado() {
            const estado = document.getElementById('cuadrilla-estado').value;
            try {
                const response = await fetch(`${baseUrl}/cuadrillas/estado/${estado}`);
                const data = await response.json();
                displayResponse('cuadrillas-estado-response', data, !response.ok);
            } catch (error) {
                displayResponse('cuadrillas-estado-response', { error: error.message }, true);
            }
        }

        async function createCuadrilla() {
            const cuadrilla = {
                nombre: document.getElementById('nueva-cuadrilla-nombre').value,
                descripcion: document.getElementById('nueva-cuadrilla-descripcion').value,
                capacidadMaxima: parseInt(document.getElementById('nueva-cuadrilla-capacidad').value),
                supervisor: document.getElementById('nueva-cuadrilla-supervisor').value,
                ubicacion: document.getElementById('nueva-cuadrilla-ubicacion').value,
                estado: 'Activa'
            };

            try {
                const response = await fetch(`${baseUrl}/cuadrillas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cuadrilla)
                });
                const data = await response.json();
                displayResponse('create-cuadrilla-response', data, !response.ok);
            } catch (error) {
                displayResponse('create-cuadrilla-response', { error: error.message }, true);
            }
        }

        // Endpoints de Colaboradores
        async function getColaboradores() {
            try {
                const response = await fetch(`${baseUrl}/colaboradores`);
                const data = await response.json();
                displayResponse('colaboradores-response', data, !response.ok);
            } catch (error) {
                displayResponse('colaboradores-response', { error: error.message }, true);
            }
        }

        async function getColaboradorById() {
            const id = document.getElementById('colaborador-id').value;
            try {
                const response = await fetch(`${baseUrl}/colaboradores/${id}`);
                const data = await response.json();
                displayResponse('colaborador-by-id-response', data, !response.ok);
            } catch (error) {
                displayResponse('colaborador-by-id-response', { error: error.message }, true);
            }
        }

        async function getColaboradoresDisponibles() {
            try {
                const response = await fetch(`${baseUrl}/colaboradores/disponibles`);
                const data = await response.json();
                displayResponse('colaboradores-disponibles-response', data, !response.ok);
            } catch (error) {
                displayResponse('colaboradores-disponibles-response', { error: error.message }, true);
            }
        }

        async function createColaborador() {
            const colaborador = {
                nombre: document.getElementById('nuevo-colaborador-nombre').value,
                apellido: document.getElementById('nuevo-colaborador-apellido').value,
                documento: document.getElementById('nuevo-colaborador-documento').value,
                email: document.getElementById('nuevo-colaborador-email').value,
                telefono: document.getElementById('nuevo-colaborador-telefono').value,
                cargo: document.getElementById('nuevo-colaborador-cargo').value,
                estado: 'Activo'
            };

            try {
                const response = await fetch(`${baseUrl}/colaboradores`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(colaborador)
                });
                const data = await response.json();
                displayResponse('create-colaborador-response', data, !response.ok);
            } catch (error) {
                displayResponse('create-colaborador-response', { error: error.message }, true);
            }
        }

        // Verificar estado de la API al cargar la p√°gina
        window.onload = function() {
            checkApiStatus();
        };

        // Captcha helpers
        async function getCaptcha() {
            try {
                const r = await fetch(`${baseUrl}/auth/captcha`);
                const d = await r.json();
                displayResponse('captcha-response', d, !r.ok);
                if (r.ok) {
                    const img = document.getElementById('captcha-img');
                    const q = document.getElementById('captcha-question');
                    const idEl = document.getElementById('captcha-id');
                    const lnk = document.getElementById('captcha-image-link');
                    q.textContent = d.question || '(no disponible)';
                    idEl.textContent = d.id || '(no disponible)';
                    if (img && d.image) {
                        img.src = d.image;
                        img.onerror = function(){ img.src = `${baseUrl}/auth/captcha/image/${d.id}?t=${Date.now()}` }
                    } else if (img) {
                        img.src = `${baseUrl}/auth/captcha/image/${d.id}?t=${Date.now()}`;
                    }
                    if (lnk) {
                        lnk.href = `${baseUrl}/auth/captcha/image/${d.id}?t=${Date.now()}`;
                    }
                }
            } catch (error) {
                displayResponse('captcha-response', { error: error.message }, true);
            }
        }

        async function refreshCaptcha(){
            await getCaptcha();
        }
    </script>
</body>
</html>