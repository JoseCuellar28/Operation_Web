<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>System Verification Suite (20 Tests)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Load Application Scripts -->
    <script src="../frontend/Modelo_Funcional/js/ui-components.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
    <!-- Mock Dashboard Environment -->
    <script>
        // Mock localStorage
        const localStorageMock = {
            getItem: (key) => null,
            setItem: (key, value) => { },
            removeItem: (key) => { }
        };
        Object.defineProperty(window, 'localStorage', { value: localStorageMock });
    </script>
</head>

<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
        <h1 class="text-2xl font-bold mb-4">System Verification Suite</h1>
        <div id="progress" class="mb-4 font-mono">Running tests...</div>
        <div id="results" class="space-y-2 font-mono text-sm"></div>

        <!-- Hidden Container for Dashboard Elements -->
        <div id="dashboard-container" class="hidden">
            <div id="colaboradores-tbody"></div>
            <div id="contador-colaboradores"></div>
            <div id="pagination-numbers"></div>
            <input id="buscarColaboradores" type="text">
        </div>
    </div>

    <script type="module">
        // Import dashboard script dynamically to catch load errors
        import '../frontend/Modelo_Funcional/js/dashboard_moderno.js';

        const results = document.getElementById('results');
        const progress = document.getElementById('progress');
        let passed = 0;
        let failed = 0;

        function log(testName, success, msg = '') {
            const div = document.createElement('div');
            div.className = `p-2 rounded ${success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            div.innerHTML = `<strong>${success ? 'PASS' : 'FAIL'}</strong>: ${testName} ${msg ? `(${msg})` : ''}`;
            results.appendChild(div);
            if (success) passed++; else failed++;
            progress.textContent = `Completed: ${passed + failed}/20 | Passed: ${passed} | Failed: ${failed}`;
        }

        async function runTests() {
            // Wait for script to load
            await new Promise(r => setTimeout(r, 1000));

            // 1. Check ModernDashboard Class
            try {
                if (typeof ModernDashboard === 'function') log('1. ModernDashboard Class Defined', true);
                else log('1. ModernDashboard Class Defined', false, 'Type is ' + typeof ModernDashboard);
            } catch (e) { log('1. ModernDashboard Class Defined', false, e.message); }

            // 2. Check UIComponents
            try {
                if (window.UIComponents) log('2. UIComponents Loaded', true);
                else log('2. UIComponents Loaded', false);
            } catch (e) { log('2. UIComponents Loaded', false, e.message); }

            // 3. Check API_NET Constant
            try {
                if (typeof API_NET !== 'undefined') log('3. API_NET Constant Defined', true, API_NET);
                else log('3. API_NET Constant Defined', false);
            } catch (e) { log('3. API_NET Constant Defined', false, e.message); }

            // 4. Check API_FASE4 Constant
            try {
                if (typeof API_FASE4 !== 'undefined') log('4. API_FASE4 Constant Defined', true, API_FASE4);
                else log('4. API_FASE4 Constant Defined', false);
            } catch (e) { log('4. API_FASE4 Constant Defined', false, e.message); }

            // 5. Ping API_NET (SystemSettings)
            try {
                const start = Date.now();
                const res = await fetch(`${API_NET}/api/SystemSettings`, { method: 'GET' }); // Might be 401 but that means it's up
                const duration = Date.now() - start;
                if (res.status === 200 || res.status === 401) log('5. API_NET Reachability', true, `Status: ${res.status}, Time: ${duration}ms`);
                else log('5. API_NET Reachability', false, `Status: ${res.status}`);
            } catch (e) { log('5. API_NET Reachability', false, 'Network Error: ' + e.message); }

            // 6. Ping API_NET (Personal - Public)
            try {
                const res = await fetch(`${API_NET}/api/personal`, { method: 'GET' });
                if (res.ok) log('6. API_NET Personal Endpoint', true);
                else log('6. API_NET Personal Endpoint', false, `Status: ${res.status}`);
            } catch (e) { log('6. API_NET Personal Endpoint', false, e.message); }

            // 7. Check DOM Elements
            if (document.getElementById('colaboradores-tbody')) log('7. Table Body Element Exists', true);
            else log('7. Table Body Element Exists', false);

            // 8. Check Dashboard Instance
            if (window.dashboard instanceof ModernDashboard) log('8. Dashboard Instance Created', true);
            else log('8. Dashboard Instance Created', false);

            // 9. Verify cargarEmpleados method
            if (window.dashboard && typeof window.dashboard.cargarEmpleados === 'function') log('9. cargarEmpleados Method Exists', true);
            else log('9. cargarEmpleados Method Exists', false);

            // 10. Verify renderTablaEmpleados method
            if (window.dashboard && typeof window.dashboard.renderTablaEmpleados === 'function') log('10. renderTablaEmpleados Method Exists', true);
            else log('10. renderTablaEmpleados Method Exists', false);

            // 11. Verify filtrarColaboradores method
            if (window.dashboard && typeof window.dashboard.filtrarColaboradores === 'function') log('11. filtrarColaboradores Method Exists', true);
            else log('11. filtrarColaboradores Method Exists', false);

            // 12. Test Mock Data Fallback (Simulated)
            try {
                const mockRows = [{ dni: 'TEST1', inspector: 'MOCK USER', estado: 'ACTIVO' }];
                window.dashboard.todosLosEmpleados = mockRows;
                window.dashboard.finalizarCargaEmpleados('Test');
                const html = document.getElementById('colaboradores-tbody').innerHTML;
                if (html.includes('MOCK USER')) log('12. Table Rendering Logic', true);
                else log('12. Table Rendering Logic', false, 'Mock data not found in DOM');
            } catch (e) { log('12. Table Rendering Logic', false, e.message); }

            // 13. Verify Row Structure
            const rowHtml = document.getElementById('colaboradores-tbody').innerHTML;
            if (rowHtml.includes('<tr') && rowHtml.includes('<td')) log('13. Row Structure (tr/td)', true);
            else log('13. Row Structure (tr/td)', false, 'Missing tr/td tags');

            // 14. Verify Status Styling
            if (rowHtml.includes('bg-green')) log('14. Status Styling (Activo)', true);
            else log('14. Status Styling (Activo)', false, 'Missing bg-green class');

            // 15. Verify Pagination Controls
            window.dashboard.updatePaginationControls();
            const pagHtml = document.getElementById('pagination-numbers').innerHTML;
            if (pagHtml.includes('PÃ¡gina 1')) log('15. Pagination Controls Rendered', true);
            else log('15. Pagination Controls Rendered', false);

            // 16. Verify Filter Logic
            window.dashboard.todosLosEmpleados = [
                { dni: '111', inspector: 'JUAN PEREZ' },
                { dni: '222', inspector: 'MARIA LOPEZ' }
            ];
            window.dashboard.filtrarColaboradores('MARIA');
            if (window.dashboard.empleadosFiltrados.length === 1 && window.dashboard.empleadosFiltrados[0].dni === '222')
                log('16. Filter Logic', true);
            else log('16. Filter Logic', false, `Expected 1 result, got ${window.dashboard.empleadosFiltrados.length}`);

            // 17. Verify Config Load Logic
            if (typeof window.dashboard.cargarConfiguracion === 'function') log('17. cargarConfiguracion Method Exists', true);
            else log('17. cargarConfiguracion Method Exists', false);

            // 18. Verify Config Save Logic
            if (typeof window.dashboard.guardarConfiguracion === 'function') log('18. guardarConfiguracion Method Exists', true);
            else log('18. guardarConfiguracion Method Exists', false);

            // 19. Verify Email Test Logic
            if (typeof window.dashboard.probarEmail === 'function') log('19. probarEmail Method Exists', true);
            else log('19. probarEmail Method Exists', false);

            // 20. Global Bridge Functions
            if (typeof window.filtrarColaboradores === 'function' && typeof window.guardarConfiguracion === 'function')
                log('20. Global Bridge Functions', true);
            else log('20. Global Bridge Functions', false);

            // Final Summary
            const summary = document.createElement('div');
            summary.className = 'mt-4 p-4 font-bold ' + (failed === 0 ? 'bg-green-200' : 'bg-red-200');
            summary.textContent = failed === 0 ? 'ALL TESTS PASSED' : 'SOME TESTS FAILED';
            results.appendChild(summary);
        }

        runTests();
    </script>
</body>

</html>