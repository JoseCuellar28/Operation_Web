<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Verify Upload Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="../frontend/Modelo_Funcional/js/ui-components.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</head>

<body>
    <div id="results"></div>
    <div id="dashboard-container" style="display:none;">
        <button onclick="document.getElementById('input-carga-masiva').click()">Cargar</button>
        <input type="file" id="input-carga-masiva">
        <div id="colaboradores-tbody"></div>
    </div>

    <script type="module">
        import '../frontend/Modelo_Funcional/js/dashboard_moderno.js';

        async function runTest() {
            await new Promise(r => setTimeout(r, 1000));

            const results = document.getElementById('results');
            function log(msg, success) {
                results.innerHTML += `<div style="color: ${success ? 'green' : 'red'}">${msg}</div>`;
            }

            if (typeof window.dashboard.procesarArchivoColaboradores === 'function') {
                log('Method procesarArchivoColaboradores exists', true);
            } else {
                log('Method procesarArchivoColaboradores missing', false);
                return;
            }

            if (typeof XLSX !== 'undefined') {
                log('XLSX library loaded', true);
            } else {
                log('XLSX library missing', false);
            }

            // Create a mock workbook
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet([
                { DNI: '99999999', NOMBRE: 'TEST UPLOAD', PUESTO: 'TESTER' }
            ]);
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });

            // Create a mock File
            const file = new File([wbout], "test.xlsx", { type: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" });

            // Mock input
            const input = { files: [file], value: '' };

            // Mock fetch to avoid actual network calls but verify logic
            const originalFetch = window.fetch;
            let fetchCalled = false;
            window.fetch = async (url, options) => {
                if (url.includes('/api/personal') && options.method === 'POST') {
                    fetchCalled = true;
                    const body = JSON.parse(options.body);
                    if (body.DNI === '99999999' && body.Inspector === 'TEST UPLOAD') {
                        log('Fetch called with correct data', true);
                    } else {
                        log('Fetch called with wrong data: ' + options.body, false);
                    }
                    return { ok: true, json: async () => ({}) };
                }
                return originalFetch(url, options);
            };

            // Mock alert
            window.alert = (msg) => log('Alert called: ' + msg, true);

            // Run upload
            try {
                await window.dashboard.procesarArchivoColaboradores(input);
                if (fetchCalled) log('Upload process completed successfully', true);
                else log('Upload process finished but fetch not called', false);
            } catch (e) {
                log('Error during upload: ' + e.message, false);
            }
        }

        runTest();
    </script>
</body>

</html>