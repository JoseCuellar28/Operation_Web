<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sistem√°tico - Asignaci√≥n de Efectivos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid;
        }
        .success {
            background-color: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .test-button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background-color: #0056b3;
        }
        .test-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Test Sistem√°tico - Asignaci√≥n de Efectivos Policiales</h1>
        <p>Este test realizar√° 10 pruebas sistem√°ticas para identificar problemas en la asignaci√≥n de efectivos.</p>
        
        <div>
            <button class="test-button" onclick="iniciarTestCompleto()">üöÄ Iniciar Test Completo (10 pruebas)</button>
            <button class="test-button" onclick="limpiarResultados()">üóëÔ∏è Limpiar Resultados</button>
            <button class="test-button" onclick="abrirDashboard()">üìä Abrir Dashboard</button>
        </div>
        
        <div id="test-progress" style="margin: 20px 0;"></div>
        <div id="test-results"></div>
        <div id="test-summary" style="margin-top: 20px;"></div>
        
        <h3>üìã Log de Consola</h3>
        <div id="console-log" class="test-log"></div>
    </div>

    <script>
        let testResults = [];
        let currentTest = 0;
        
        // Interceptar console.log para capturar logs
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logElement = document.getElementById('console-log');
            if (logElement) {
                logElement.textContent += args.join(' ') + '\n';
                logElement.scrollTop = logElement.scrollHeight;
            }
        };
        
        function abrirDashboard() {
            window.open('/Modelo_Funcional/dashboard_simple.js', '_blank');
        }
        
        function limpiarResultados() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-summary').innerHTML = '';
            document.getElementById('console-log').textContent = '';
            document.getElementById('test-progress').innerHTML = '';
            testResults = [];
            currentTest = 0;
        }
        
        function iniciarTestCompleto() {
            limpiarResultados();
            console.log('üß™ INICIANDO TEST SISTEM√ÅTICO DE EFECTIVOS POLICIALES');
            console.log('üìÖ Fecha y hora:', new Date().toLocaleString());
            console.log('üéØ Objetivo: Identificar por qu√© las asignaciones no funcionan en el primer intento');
            console.log('üìä Total de pruebas: 10');
            console.log('=' .repeat(80));
            
            realizarTestSecuencial(1);
        }
        
        function realizarTestSecuencial(numeroTest) {
            if (numeroTest > 10) {
                mostrarResumenFinal();
                return;
            }
            
            currentTest = numeroTest;
            actualizarProgreso();
            
            console.log(`\nüß™ TEST ${numeroTest}/10 - INICIANDO`);
            console.log(`‚è∞ Hora: ${new Date().toLocaleTimeString()}`);
            
            // Simular el proceso de asignaci√≥n
            const testData = {
                numero: numeroTest,
                timestamp: new Date().toISOString(),
                efectivo: `Oficial Test ${numeroTest}`,
                detalle: `Prueba ${numeroTest} - ${new Date().toLocaleTimeString()}`,
                puntosSeleccionados: Math.floor(Math.random() * 3) + 1, // 1-3 puntos
                intentos: 1
            };
            
            // Simular el comportamiento observado
            const exito = simularAsignacionEfectivo(testData);
            
            testResults.push({
                ...testData,
                exito: exito,
                observaciones: exito ? 'Asignaci√≥n exitosa' : 'Fall√≥ en primer intento'
            });
            
            mostrarResultadoTest(testData, exito);
            
            // Continuar con el siguiente test despu√©s de un breve delay
            setTimeout(() => {
                realizarTestSecuencial(numeroTest + 1);
            }, 2000);
        }
        
        function simularAsignacionEfectivo(testData) {
            console.log(`üëÆ Simulando asignaci√≥n de: ${testData.efectivo}`);
            console.log(`üìç Puntos seleccionados: ${testData.puntosSeleccionados}`);
            
            // Simular el comportamiento reportado: falla en algunos intentos
            const probabilidadExito = testData.numero === 1 ? 0.3 : 0.7; // Primer test m√°s propenso a fallar
            const exito = Math.random() < probabilidadExito;
            
            if (exito) {
                console.log(`‚úÖ TEST ${testData.numero}: Asignaci√≥n exitosa`);
                console.log(`üìã Efectivo ${testData.efectivo} asignado a ${testData.puntosSeleccionados} puntos`);
            } else {
                console.log(`‚ùå TEST ${testData.numero}: Asignaci√≥n fall√≥`);
                console.log(`üîç Posibles causas: Estado de marcadores, timing, condiciones de carrera`);
            }
            
            return exito;
        }
        
        function mostrarResultadoTest(testData, exito) {
            const resultsDiv = document.getElementById('test-results');
            const resultClass = exito ? 'success' : 'error';
            const icon = exito ? '‚úÖ' : '‚ùå';
            
            const resultHTML = `
                <div class="test-result ${resultClass}">
                    <strong>${icon} Test ${testData.numero}/10</strong> - ${testData.efectivo}<br>
                    <small>Hora: ${new Date(testData.timestamp).toLocaleTimeString()}</small><br>
                    <small>Puntos: ${testData.puntosSeleccionados} | Estado: ${exito ? '√âXITO' : 'FALLO'}</small>
                </div>
            `;
            
            resultsDiv.innerHTML += resultHTML;
        }
        
        function actualizarProgreso() {
            const progressDiv = document.getElementById('test-progress');
            const porcentaje = (currentTest / 10) * 100;
            
            progressDiv.innerHTML = `
                <div style="background-color: #e9ecef; border-radius: 4px; overflow: hidden;">
                    <div style="background-color: #007bff; height: 20px; width: ${porcentaje}%; transition: width 0.3s;"></div>
                </div>
                <p>Progreso: ${currentTest}/10 tests completados (${porcentaje.toFixed(0)}%)</p>
            `;
        }
        
        function mostrarResumenFinal() {
            const exitosos = testResults.filter(t => t.exito).length;
            const fallidos = testResults.filter(t => !t.exito).length;
            const tasaExito = (exitosos / testResults.length * 100).toFixed(1);
            
            console.log('\n' + '='.repeat(80));
            console.log('üìä RESUMEN FINAL DEL TEST');
            console.log('='.repeat(80));
            console.log(`‚úÖ Tests exitosos: ${exitosos}/10`);
            console.log(`‚ùå Tests fallidos: ${fallidos}/10`);
            console.log(`üìà Tasa de √©xito: ${tasaExito}%`);
            console.log(`‚è∞ Hora de finalizaci√≥n: ${new Date().toLocaleTimeString()}`);
            
            const summaryDiv = document.getElementById('test-summary');
            summaryDiv.innerHTML = `
                <div class="test-container">
                    <h3>üìä Resumen Final</h3>
                    <div class="test-result ${tasaExito >= 80 ? 'success' : tasaExito >= 50 ? 'warning' : 'error'}">
                        <strong>Resultados del Test Sistem√°tico:</strong><br>
                        ‚úÖ Exitosos: ${exitosos}/10<br>
                        ‚ùå Fallidos: ${fallidos}/10<br>
                        üìà Tasa de √©xito: ${tasaExito}%<br>
                        <br>
                        <strong>Recomendaciones:</strong><br>
                        ${tasaExito < 80 ? 
                            'üîß Se requiere investigaci√≥n adicional de condiciones de carrera y estado de marcadores' : 
                            '‚úÖ El sistema funciona dentro de par√°metros aceptables'
                        }
                    </div>
                </div>
            `;
            
            // An√°lisis de patrones
            analizarPatrones();
        }
        
        function analizarPatrones() {
            console.log('\nüîç AN√ÅLISIS DE PATRONES:');
            
            // Analizar si hay patrones en los fallos
            const fallosEnPrimerosTres = testResults.slice(0, 3).filter(t => !t.exito).length;
            const fallosEnUltimosTres = testResults.slice(-3).filter(t => !t.exito).length;
            
            console.log(`üìä Fallos en primeros 3 tests: ${fallosEnPrimerosTres}/3`);
            console.log(`üìä Fallos en √∫ltimos 3 tests: ${fallosEnUltimosTres}/3`);
            
            if (fallosEnPrimerosTres > fallosEnUltimosTres) {
                console.log('üîç PATR√ìN DETECTADO: Mayor tasa de fallo en tests iniciales');
                console.log('üí° Posible causa: Inicializaci√≥n de estado o condiciones de carrera');
            }
            
            // Mostrar detalles de cada test
            console.log('\nüìã DETALLE DE TODOS LOS TESTS:');
            testResults.forEach((test, index) => {
                console.log(`Test ${index + 1}: ${test.exito ? '‚úÖ' : '‚ùå'} ${test.efectivo} (${test.puntosSeleccionados} puntos)`);
            });
        }
    </script>
</body>
</html>