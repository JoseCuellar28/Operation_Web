<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Completa - Mapa y Men√∫ Corregido</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- DOMPurify for XSS protection -->
    <script src="js/vendor/purify.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
        }

        .prueba-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .prueba-header {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .prueba-header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .prueba-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .mapa-section {
            padding: 20px;
        }

        .selector-columna-ubicacion {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .selector-columna-ubicacion label {
            font-weight: 600;
            color: #374151;
            margin: 0;
        }

        .form-select {
            min-width: 200px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            padding: 8px 12px;
            transition: border-color 0.3s ease;
        }

        .form-select:focus {
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.1);
        }

        .btn-mapa {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-mapa:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        #mapa-container {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            position: relative;
            display: flex;
        }

        #mapa-leaflet {
            flex: 1;
            width: 100%;
            height: 100%;
        }

        /* Estilos para el men√∫ lateral de puntos seleccionados */
        .menu-lateral-puntos {
            width: 350px;
            background: white;
            border-left: 1px solid #e5e7eb;
            box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            animation: slideInFromRight 0.3s ease-out;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            flex-shrink: 0;
        }

        .menu-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-cerrar-menu {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .btn-cerrar-menu:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .menu-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        .menu-acciones {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn-accion {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .btn-accion-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-accion-primary:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-accion-secondary {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            color: white;
        }

        .btn-accion-secondary:hover {
            background: linear-gradient(135deg, #0369a1 0%, #075985 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
        }

        .btn-accion-info {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            color: white;
        }

        .btn-accion-info:hover {
            background: linear-gradient(135deg, #6d28d9 0%, #5b21b6 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        .btn-accion-success {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
        }

        .btn-accion-success:hover {
            background: linear-gradient(135deg, #15803d 0%, #166534 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }

        /* Estilos para modal centrado */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            text-align: center;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            color: #16a34a;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .modal-body {
            text-align: left;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-close-btn {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .modal-close-btn:hover {
            background: linear-gradient(135deg, #15803d 0%, #166534 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }

        /* Estilos para dropdowns */
        .dropdown-asignacion {
            position: relative;
            margin-bottom: 12px;
        }

        .btn-dropdown {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .btn-dropdown-primary {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
        }

        .btn-dropdown-primary:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-dropdown-secondary {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            color: white;
        }

        .btn-dropdown-secondary:hover {
            background: linear-gradient(135deg, #0369a1 0%, #075985 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
        }

        /* Estilos para los selectores simples */
        .dropdown-asignacion {
            margin-bottom: 15px;
        }

        .form-select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background-color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-select:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .form-select option {
            padding: 10px;
            font-size: 14px;
        }



        .status-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 4px solid #0284c7;
        }

        .status-info h5 {
            margin: 0 0 10px 0;
            color: #0369a1;
            font-size: 14px;
            font-weight: 600;
        }

        .status-info p {
            margin: 5px 0;
            font-size: 13px;
            color: #374151;
        }

        .alert {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        .alert-success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
        }

        .alert-info {
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            color: #1e40af;
        }
    </style>
</head>

<body>
    <div class="prueba-container">
        <div class="prueba-header">
            <h1><i class="fas fa-map-marked-alt"></i> Prueba Completa - Mapa y Men√∫ Corregido</h1>
            <p>Esta p√°gina replica el comportamiento completo del mapa con todas las correcciones aplicadas al men√∫
                lateral</p>
        </div>

        <div class="mapa-section">
            <div class="selector-columna-ubicacion">
                <label for="selector-columna-geo"><strong>Selecciona la columna que contiene la
                        ubicaci√≥n:</strong></label>
                <select id="selector-columna-geo" class="form-select">
                    <option value="">-- Selecciona una columna --</option>
                    <option value="UBICACI√ìN">UBICACI√ìN</option>
                </select>
                <button type="button" class="btn-mapa" onclick="cargarMapaConColumna()">
                    <i class="fas fa-map-marker-alt"></i> Cargar Mapa
                </button>
            </div>

            <div id="mapa-container">
                <div id="mapa-leaflet"></div>

                <!-- Men√∫ lateral para puntos seleccionados -->
                <div id="menu-lateral-puntos" class="menu-lateral-puntos" style="display: none;">
                    <div class="menu-header">
                        <h4><i class="fas fa-map-pin"></i> Puntos Seleccionados (<span id="contador-puntos">0</span>)
                        </h4>
                        <button type="button" class="btn-cerrar-menu" onclick="cerrarMenuPuntos()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="menu-content">
                        <div class="menu-acciones">
                            <!-- Selector simple para Asignar Cuadrilla -->
                            <div class="dropdown-asignacion">
                                <select class="form-select" onchange="asignarCuadrillaSelect(this)"
                                    style="margin-bottom: 10px;">
                                    <option value="">üöõ Seleccionar Cuadrilla</option>
                                    <option value="Cuadrilla Alpha|Zona Norte - Disponible">üõ°Ô∏è Cuadrilla Alpha - Zona
                                        Norte</option>
                                    <option value="Cuadrilla Beta|Zona Sur - En servicio">üåô Cuadrilla Beta - Zona Sur
                                    </option>
                                    <option value="Cuadrilla Gamma|Zona Este - Disponible">üöó Cuadrilla Gamma - Zona
                                        Este</option>
                                    <option value="Cuadrilla Delta|Base Central - Mantenimiento">üîß Cuadrilla Delta -
                                        Base Central</option>
                                </select>
                            </div>

                            <!-- Selector m√∫ltiple para Asignar Efectivos Policiales -->
                            <div class="dropdown-asignacion">
                                <div
                                    style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
                                    <div style="font-weight: bold; margin-bottom: 8px; color: #495057;">
                                        üëÆ Seleccionar Efectivos Policiales
                                    </div>
                                    <div id="efectivos-checkboxes" style="max-height: 150px; overflow-y: auto;">
                                        <label style="display: block; margin-bottom: 6px; cursor: pointer;">
                                            <input type="checkbox" value="Oficial Garc√≠a|Sargento - Disponible"
                                                style="margin-right: 8px;">
                                            üõ°Ô∏è Oficial Garc√≠a - Sargento
                                        </label>
                                        <label style="display: block; margin-bottom: 6px; cursor: pointer;">
                                            <input type="checkbox" value="Oficial Rodr√≠guez|Cabo - En patrulla"
                                                style="margin-right: 8px;">
                                            üöî Oficial Rodr√≠guez - Cabo
                                        </label>
                                        <label style="display: block; margin-bottom: 6px; cursor: pointer;">
                                            <input type="checkbox" value="Oficial L√≥pez|Oficial - Disponible"
                                                style="margin-right: 8px;">
                                            üëÆ Oficial L√≥pez - Oficial
                                        </label>
                                        <label style="display: block; margin-bottom: 6px; cursor: pointer;">
                                            <input type="checkbox" value="Oficial Mart√≠nez|Teniente - En descanso"
                                                style="margin-right: 8px;">
                                            ‚≠ê Oficial Mart√≠nez - Teniente
                                        </label>
                                    </div>
                                    <div style="margin-top: 10px; text-align: center;">
                                        <button onclick="asignarEfectivosSeleccionados()"
                                            style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ‚úÖ Asignar Seleccionados
                                        </button>
                                        <button onclick="limpiarSeleccionEfectivos()"
                                            style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 5px;">
                                            üóëÔ∏è Limpiar
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Bot√≥n para guardar asignaci√≥n -->
                            <button type="button" class="btn-accion btn-accion-success" onclick="guardarAsignacion()">
                                <i class="fas fa-save"></i> Guardar Asignaci√≥n
                            </button>
                        </div>

                        <!-- Lista desplegable de cuadrillas -->
                        <div id="lista-cuadrillas" class="lista-cuadrillas" style="display: none;">
                            <div class="lista-header">
                                <h5 id="titulo-lista">Seleccionar Cuadrilla</h5>
                                <button type="button" class="btn-cerrar-lista" onclick="cerrarListaCuadrillas()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                            <div class="lista-opciones">
                                <button type="button" class="opcion-cuadrilla"
                                    onclick="seleccionarCuadrilla('Cuadrilla Mantenimiento A', 'Reparaci√≥n de infraestructura urbana')">
                                    <i class="fas fa-tools"></i>
                                    <div class="info-cuadrilla">
                                        <div class="nombre-cuadrilla">Cuadrilla Mantenimiento A</div>
                                        <div class="detalle-cuadrilla">Reparaci√≥n de infraestructura urbana</div>
                                    </div>
                                </button>
                                <button type="button" class="opcion-cuadrilla"
                                    onclick="seleccionarCuadrilla('Cuadrilla El√©ctrica B', 'Instalaci√≥n y mantenimiento el√©ctrico')">
                                    <i class="fas fa-bolt"></i>
                                    <div class="info-cuadrilla">
                                        <div class="nombre-cuadrilla">Cuadrilla El√©ctrica B</div>
                                        <div class="detalle-cuadrilla">Instalaci√≥n y mantenimiento el√©ctrico</div>
                                    </div>
                                </button>
                                <button type="button" class="opcion-cuadrilla"
                                    onclick="seleccionarCuadrilla('Cuadrilla Limpieza C', 'Limpieza y mantenimiento general')">
                                    <i class="fas fa-broom"></i>
                                    <div class="info-cuadrilla">
                                        <div class="nombre-cuadrilla">Cuadrilla Limpieza C</div>
                                        <div class="detalle-cuadrilla">Limpieza y mantenimiento general</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <!-- Lista desplegable de efectivos -->
                        <div id="lista-efectivos" class="lista-cuadrillas" style="display: none;">
                            <div class="lista-header">
                                <h5 id="titulo-lista-efectivos">Seleccionar Efectivo Policial</h5>
                                <button type="button" class="btn-cerrar-lista" onclick="cerrarListaEfectivos()">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                            </div>
                            <div class="lista-opciones">
                                <button type="button" class="opcion-cuadrilla"
                                    onclick="seleccionarEfectivo('Oficial Garc√≠a', 'Patrulla Sector Norte')">
                                    <i class="fas fa-shield-alt"></i>
                                    <div class="info-cuadrilla">
                                        <div class="nombre-cuadrilla">Oficial Garc√≠a</div>
                                        <div class="detalle-cuadrilla">Patrulla Sector Norte</div>
                                    </div>
                                </button>
                                <button type="button" class="opcion-cuadrilla"
                                    onclick="seleccionarEfectivo('Sargento L√≥pez', 'Unidad M√≥vil 02')">
                                    <i class="fas fa-shield-alt"></i>
                                    <div class="info-cuadrilla">
                                        <div class="nombre-cuadrilla">Sargento L√≥pez</div>
                                        <div class="detalle-cuadrilla">Unidad M√≥vil 02</div>
                                    </div>
                                </button>
                                <button type="button" class="opcion-cuadrilla"
                                    onclick="seleccionarEfectivo('Cabo Mart√≠nez', 'Patrulla Sector Sur')">
                                    <i class="fas fa-shield-alt"></i>
                                    <div class="info-cuadrilla">
                                        <div class="nombre-cuadrilla">Cabo Mart√≠nez</div>
                                        <div class="detalle-cuadrilla">Patrulla Sector Sur</div>
                                    </div>
                                </button>
                            </div>
                        </div>

                        <div class="status-info">
                            <h5><i class="fas fa-info-circle"></i> Estado del Men√∫</h5>
                            <p><strong>ID del men√∫:</strong> menu-lateral-puntos ‚úÖ</p>
                            <p><strong>Funci√≥n mostrarMenuPuntosSeleccionados:</strong> Corregida ‚úÖ</p>
                            <p><strong>Funciones de selecci√≥n:</strong> Implementadas ‚úÖ</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="alert alert-info">
                <strong><i class="fas fa-info-circle"></i> Instrucciones de Prueba:</strong><br>
                1. Haz clic en "Cargar Mapa" para inicializar el mapa<br>
                2. Haz clic en algunos marcadores para seleccionarlos<br>
                3. Observa que aparece el men√∫ lateral<br>
                4. Prueba "Asignar Cuadrilla" y "Asignar Efectivo Policial"<br>
                5. Verifica que el men√∫ permanece visible despu√©s de las asignaciones
            </div>

            <div id="resultado-pruebas"></div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variables globales
        let mapa;
        let marcadoresSeleccionados = [];
        let todosLosMarcadores = [];
        let marcadoresEnMapa = []; // Array para almacenar todos los marcadores en el mapa
        let puntosSeleccionados = []; // Array para almacenar los puntos seleccionados
        let asignaciones = []; // Array para almacenar las asignaciones

        // Datos de prueba para cuadrillas y efectivos
        const cuadrillas = [
            { id: 1, nombre: "Cuadrilla Alpha", estado: "Disponible", ubicacion: "Zona Norte" },
            { id: 2, nombre: "Cuadrilla Beta", estado: "En servicio", ubicacion: "Zona Sur" },
            { id: 3, nombre: "Cuadrilla Gamma", estado: "Disponible", ubicacion: "Zona Este" },
            { id: 4, nombre: "Cuadrilla Delta", estado: "Mantenimiento", ubicacion: "Base Central" }
        ];

        const efectivos = [
            { id: 1, nombre: "Oficial Garc√≠a", rango: "Sargento", estado: "Disponible" },
            { id: 2, nombre: "Oficial Rodr√≠guez", rango: "Cabo", estado: "En patrulla" },
            { id: 3, nombre: "Oficial L√≥pez", rango: "Oficial", estado: "Disponible" },
            { id: 4, nombre: "Oficial Mart√≠nez", rango: "Teniente", estado: "En descanso" }
        ];

        // Datos de prueba
        const datosPrueba = [
            { ubicacion: "Lima, Per√∫", lat: -12.0464, lng: -77.0428, nombre: "Punto 1" },
            { ubicacion: "Callao, Per√∫", lat: -12.0566, lng: -77.1181, nombre: "Punto 2" },
            { ubicacion: "San Isidro, Lima", lat: -12.1021, lng: -77.0365, nombre: "Punto 3" },
            { ubicacion: "Miraflores, Lima", lat: -12.1196, lng: -77.0289, nombre: "Punto 4" },
            { ubicacion: "Surco, Lima", lat: -12.1391, lng: -77.0178, nombre: "Punto 5" }
        ];

        function cargarMapaConColumna() {
            const selector = document.getElementById('selector-columna-geo');
            const columnaSeleccionada = selector.value;

            if (!columnaSeleccionada) {
                alert('Por favor selecciona una columna primero');
                return;
            }

            // Inicializar el mapa
            if (mapa) {
                mapa.remove();
            }

            mapa = L.map('mapa-leaflet').setView([-12.0464, -77.0428], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapa);

            // Agregar marcadores de prueba
            datosPrueba.forEach((punto, index) => {
                const marcador = L.marker([punto.lat, punto.lng])
                    .addTo(mapa)
                    .bindPopup(`<strong>${punto.nombre}</strong><br>${punto.ubicacion}`);

                marcador.puntoData = punto;
                marcador.indice = index;

                marcador.on('click', function () {
                    seleccionarMarcador(this);
                });

                todosLosMarcadores.push(marcador);
            });

            mostrarResultado('Mapa cargado correctamente con ' + datosPrueba.length + ' puntos de prueba', 'success');
        }

        function seleccionarMarcador(marcador) {
            const index = marcadoresSeleccionados.findIndex(m => m.indice === marcador.indice);

            if (index === -1) {
                // Agregar a seleccionados
                marcadoresSeleccionados.push(marcador);
                puntosSeleccionados.push({
                    indice: marcador.indice,
                    nombre: marcador.nombre || `Punto ${marcador.indice + 1}`,
                    lat: marcador.getLatLng().lat,
                    lng: marcador.getLatLng().lng
                });
                marcador.setIcon(L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }));
            } else {
                // Quitar de seleccionados
                marcadoresSeleccionados.splice(index, 1);
                const puntoIndex = puntosSeleccionados.findIndex(p => p.indice === marcador.indice);
                if (puntoIndex !== -1) {
                    puntosSeleccionados.splice(puntoIndex, 1);
                }
                marcador.setIcon(L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                }));
            }

            console.log('üìç Puntos seleccionados actualizados:', puntosSeleccionados);
            actualizarMenuPuntos();
        }

        function actualizarMenuPuntos() {
            const contador = document.getElementById('contador-puntos');
            contador.textContent = marcadoresSeleccionados.length;

            if (marcadoresSeleccionados.length > 0) {
                mostrarMenuPuntosSeleccionados();
            } else {
                cerrarMenuPuntos();
            }
        }

        // FUNCI√ìN CORREGIDA - Usa el ID correcto del men√∫
        function mostrarMenuPuntosSeleccionados() {
            const menu = document.getElementById('menu-lateral-puntos'); // ID CORREGIDO
            if (menu) {
                menu.style.display = 'flex';
                console.log('‚úÖ Men√∫ mostrado correctamente');
                mostrarResultado('Men√∫ lateral mostrado - Funci√≥n corregida funcionando', 'success');
            } else {
                console.error('‚ùå No se encontr√≥ el elemento del men√∫');
                mostrarResultado('Error: No se encontr√≥ el elemento del men√∫', 'danger');
            }
        }

        function cerrarMenuPuntos() {
            const menu = document.getElementById('menu-lateral-puntos');
            if (menu) {
                menu.style.display = 'none';
                // Cerrar tambi√©n las listas si est√°n abiertas
                cerrarListaCuadrillas();
                cerrarListaEfectivos();
            }
        }

        // Funciones de asignaci√≥n con selectores simples
        function asignarCuadrillaSelect(select) {
            const valor = select.value;
            if (!valor) return;

            const [nombre, detalle] = valor.split('|');
            asignarCuadrillaEspecifica(nombre, detalle);

            // Resetear el selector
            select.value = '';
        }

        function asignarEfectivoSelect(select) {
            const valor = select.value;
            if (!valor) return;

            const [nombre, detalle] = valor.split('|');
            asignarEfectivoEspecifico(nombre, detalle);

            // Resetear el selector
            select.value = '';
        }

        // Nuevas funciones para selecci√≥n m√∫ltiple de efectivos
        function asignarEfectivosSeleccionados() {
            console.log('üëÆ Funci√≥n asignarEfectivosSeleccionados llamada');

            if (marcadoresSeleccionados.length === 0) {
                alert('Por favor, selecciona al menos un punto en el mapa primero.');
                return;
            }

            const checkboxes = document.querySelectorAll('#efectivos-checkboxes input[type="checkbox"]:checked');

            if (checkboxes.length === 0) {
                alert('Por favor, selecciona al menos un efectivo policial.');
                return;
            }

            let efectivosAsignados = 0;

            checkboxes.forEach(checkbox => {
                const valor = checkbox.value;
                const [nombre, detalle] = valor.split('|');

                // Asignar este efectivo a todos los puntos seleccionados
                marcadoresSeleccionados.forEach(marcador => {
                    // Verificar si ya existe una asignaci√≥n para este punto
                    const asignacionExistente = asignaciones.find(asig =>
                        asig.puntoId === marcador._leaflet_id
                    );

                    if (asignacionExistente) {
                        // Si ya existe, agregar el efectivo a la lista
                        if (!asignacionExistente.efectivos) {
                            asignacionExistente.efectivos = [];
                        }

                        // Verificar si este efectivo ya est√° asignado a este punto
                        const efectivoExistente = asignacionExistente.efectivos.find(ef => ef.nombre === nombre);
                        if (!efectivoExistente) {
                            asignacionExistente.efectivos.push({
                                nombre: nombre,
                                detalle: detalle,
                                tipoPersonal: 'Efectivo Policial'
                            });
                            efectivosAsignados++;
                        }
                    } else {
                        // Crear nueva asignaci√≥n
                        const nuevaAsignacion = {
                            puntoId: marcador._leaflet_id,
                            puntoNombre: marcador.puntoData ? marcador.puntoData.nombre : `Punto ${marcador._leaflet_id}`,
                            coordenadas: {
                                lat: marcador.puntoData ? marcador.puntoData.lat : marcador.getLatLng().lat,
                                lng: marcador.puntoData ? marcador.puntoData.lng : marcador.getLatLng().lng
                            },
                            efectivos: [{
                                nombre: nombre,
                                detalle: detalle,
                                tipoPersonal: 'Efectivo Policial'
                            }],
                            fechaAsignacion: new Date().toISOString()
                        };

                        asignaciones.push(nuevaAsignacion);
                        efectivosAsignados++;
                    }
                });
            });

            console.log('üìã Asignaciones despu√©s de agregar efectivos m√∫ltiples:', asignaciones);

            // Mostrar mensaje de confirmaci√≥n
            mostrarModalCentrado('‚úÖ Efectivos Asignados', `
                <div style="text-align: center;">
                    <p style="font-size: 16px; margin-bottom: 10px;">
                        Se han asignado <strong>${checkboxes.length} efectivos</strong> a <strong>${marcadoresSeleccionados.length} puntos</strong>
                    </p>
                    <p style="color: #6c757d; font-size: 14px;">
                        Total de asignaciones creadas: ${efectivosAsignados}
                    </p>
                </div>
            `);

            // Limpiar selecciones
            limpiarSeleccionEfectivos();
        }

        function limpiarSeleccionEfectivos() {
            const checkboxes = document.querySelectorAll('#efectivos-checkboxes input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            console.log('üóëÔ∏è Selecci√≥n de efectivos limpiada');
        }

        function asignarCuadrillaEspecifica(nombre, detalle) {
            console.log('üîß Funci√≥n asignarCuadrillaEspecifica llamada:', nombre, detalle);
            console.log('üìç Marcadores seleccionados:', marcadoresSeleccionados.length);

            if (marcadoresSeleccionados.length === 0) {
                alert('Por favor, selecciona al menos un punto en el mapa primero.');
                console.log('‚ùå No hay marcadores seleccionados');
                return;
            }

            // Crear asignaci√≥n para cada punto seleccionado
            marcadoresSeleccionados.forEach(marcador => {
                const asignacionExistente = asignaciones.find(a => a.puntoId === marcador.indice);

                if (asignacionExistente) {
                    asignacionExistente.cuadrilla = { nombre, detalle };
                    asignacionExistente.fechaAsignacion = new Date().toLocaleString();
                } else {
                    const nuevaAsignacion = {
                        id: asignaciones.length + 1,
                        puntoId: marcador.indice,
                        puntoNombre: marcador.puntoData ? marcador.puntoData.nombre : `Punto ${marcador.indice + 1}`,
                        coordenadas: marcador.puntoData ? `${marcador.puntoData.lat}, ${marcador.puntoData.lng}` : `${marcador.getLatLng().lat}, ${marcador.getLatLng().lng}`,
                        cuadrilla: { nombre, detalle },
                        efectivo: null,
                        fechaAsignacion: new Date().toLocaleString(),
                        estado: 'Asignado'
                    };
                    asignaciones.push(nuevaAsignacion);
                }
            });

            console.log(`Cuadrilla ${nombre} asignada a ${marcadoresSeleccionados.length} puntos`);
            console.log('üìã Asignaciones despu√©s de agregar cuadrilla:', asignaciones);
            mostrarResultado(`Cuadrilla "${nombre}" asignada a ${marcadoresSeleccionados.length} puntos seleccionados`, 'success');
        }

        function asignarEfectivoEspecifico(nombre, detalle) {
            if (marcadoresSeleccionados.length === 0) {
                alert('Por favor, selecciona al menos un punto en el mapa primero.');
                return;
            }

            // Crear asignaci√≥n para cada punto seleccionado
            marcadoresSeleccionados.forEach(marcador => {
                const asignacionExistente = asignaciones.find(a => a.puntoId === marcador.indice);

                if (asignacionExistente) {
                    asignacionExistente.efectivo = { nombre, detalle };
                    asignacionExistente.fechaAsignacion = new Date().toLocaleString();
                } else {
                    const nuevaAsignacion = {
                        id: asignaciones.length + 1,
                        puntoId: marcador.indice,
                        puntoNombre: marcador.puntoData ? marcador.puntoData.nombre : `Punto ${marcador.indice + 1}`,
                        coordenadas: marcador.puntoData ? `${marcador.puntoData.lat}, ${marcador.puntoData.lng}` : `${marcador.getLatLng().lat}, ${marcador.getLatLng().lng}`,
                        cuadrilla: null,
                        efectivo: { nombre, detalle },
                        fechaAsignacion: new Date().toLocaleString(),
                        estado: 'Asignado'
                    };
                    asignaciones.push(nuevaAsignacion);
                }
            });

            console.log(`Efectivo ${nombre} asignado a ${marcadoresSeleccionados.length} puntos`);
            console.log('üìã Asignaciones despu√©s de agregar efectivo:', asignaciones);
            mostrarResultado(`Efectivo "${nombre}" asignado a ${marcadoresSeleccionados.length} puntos seleccionados`, 'success');
        }

        function abrirTablaAsignaciones() {
            if (asignaciones.length === 0) {
                alert('No hay asignaciones registradas.');
                return;
            }

            // Crear ventana con tabla de asignaciones
            const ventana = window.open('', 'Asignaciones', 'width=1000,height=600,scrollbars=yes');
            ventana.document.write(`
                <html>
                <head>
                    <title>Tabla de Asignaciones</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            padding: 20px; 
                            background-color: #f8f9fa;
                        }
                        .header {
                            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
                            color: white;
                            padding: 20px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                            text-align: center;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            background: white;
                            border-radius: 8px;
                            overflow: hidden;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                        }
                        th, td { 
                            padding: 12px; 
                            text-align: left; 
                            border-bottom: 1px solid #e5e7eb;
                        }
                        th { 
                            background: #f8fafc; 
                            font-weight: 600;
                            color: #374151;
                        }
                        tr:hover { 
                            background-color: #f8fafc; 
                        }
                        .badge {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: 500;
                        }
                        .badge-success {
                            background-color: #dcfce7;
                            color: #166534;
                        }
                        .no-asignado {
                            color: #6b7280;
                            font-style: italic;
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h2>üìã Tabla de Asignaciones</h2>
                        <p>Total de asignaciones: ${asignaciones.length}</p>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Punto</th>
                                <th>Coordenadas</th>
                                <th>Cuadrilla</th>
                                <th>Efectivo Policial</th>
                                <th>Fecha Asignaci√≥n</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${asignaciones.map(a => `
                                <tr>
                                    <td>${a.id}</td>
                                    <td><strong>${a.puntoNombre}</strong></td>
                                    <td>${a.coordenadas}</td>
                                    <td>${a.cuadrilla ? `<strong>${a.cuadrilla.nombre}</strong><br><small>${a.cuadrilla.detalle}</small>` : '<span class="no-asignado">No asignado</span>'}</td>
                                    <td>${a.efectivo ? `<strong>${a.efectivo.nombre}</strong><br><small>${a.efectivo.detalle}</small>` : '<span class="no-asignado">No asignado</span>'}</td>
                                    <td>${a.fechaAsignacion}</td>
                                    <td><span class="badge badge-success">${a.estado}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `);

            mostrarResultado('Tabla de asignaciones abierta en nueva ventana', 'info');
        }

        function mostrarListaCuadrillas() {
            const lista = document.getElementById('lista-cuadrillas');
            if (lista) {
                lista.style.display = 'flex';
                console.log('‚úÖ Lista de cuadrillas mostrada');
            }
        }

        function mostrarListaEfectivos() {
            const lista = document.getElementById('lista-efectivos');
            if (lista) {
                lista.style.display = 'flex';
                console.log('‚úÖ Lista de efectivos mostrada');
            }
        }

        function cerrarListaCuadrillas() {
            const lista = document.getElementById('lista-cuadrillas');
            if (lista) {
                lista.style.display = 'none';
            }
        }

        function cerrarListaEfectivos() {
            const lista = document.getElementById('lista-efectivos');
            if (lista) {
                lista.style.display = 'none';
            }
        }

        // FUNCIONES CORREGIDAS - Muestran el men√∫ despu√©s de la selecci√≥n
        function seleccionarCuadrilla(nombre, detalle) {
            console.log('‚úÖ Cuadrilla seleccionada:', nombre);
            cerrarListaCuadrillas();

            // CORRECCI√ìN: Mostrar el men√∫ despu√©s de la selecci√≥n
            const menu = document.getElementById('menu-lateral-puntos');
            if (menu) {
                menu.style.display = 'flex';
                console.log('‚úÖ Men√∫ mostrado despu√©s de seleccionar cuadrilla');
            }

            mostrarResultado(`Cuadrilla "${nombre}" asignada correctamente - Men√∫ permanece visible`, 'success');
        }

        function seleccionarEfectivo(nombre, detalle) {
            console.log('‚úÖ Efectivo seleccionado:', nombre);
            cerrarListaEfectivos();

            // CORRECCI√ìN: Mostrar el men√∫ despu√©s de la selecci√≥n
            const menu = document.getElementById('menu-lateral-puntos');
            if (menu) {
                menu.style.display = 'flex';
                console.log('‚úÖ Men√∫ mostrado despu√©s de seleccionar efectivo');
            }

            mostrarResultado(`Efectivo "${nombre}" asignado correctamente - Men√∫ permanece visible`, 'success');
        }

        function programarTarea() {
            console.log('üìÖ Funci√≥n programarTarea llamada');
            mostrarResultado('Funci√≥n programar tarea ejecutada - Men√∫ permanece visible', 'info');
        }

        function mostrarResultado(mensaje, tipo) {
            const contenedor = document.getElementById('resultado-pruebas');
            const alertClass = tipo === 'success' ? 'alert-success' :
                tipo === 'danger' ? 'alert-danger' : 'alert-info';

            const timestamp = new Date().toLocaleTimeString();

            contenedor.innerHTML = DOMPurify.sanitize(`
                <div class="alert ${alertClass}">
                    <strong>[${timestamp}]</strong> ${mensaje}
                </div>
            `) + contenedor.innerHTML;
        }

        // Funci√≥n para mostrar modal centrado
        function mostrarModalCentrado(titulo, contenido) {
            // Crear overlay del modal
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';

            // Crear contenido del modal
            overlay.innerHTML = DOMPurify.sanitize(`
                <div class="modal-content">
                    <div class="modal-header">${titulo}</div>
                    <div class="modal-body">${contenido}</div>
                    <button class="modal-close-btn" onclick="cerrarModal(this)">Cerrar</button>
                </div>
            `);

            // Agregar al body
            document.body.appendChild(overlay);

            // Cerrar modal al hacer click en el overlay
            overlay.addEventListener('click', function (e) {
                if (e.target === overlay) {
                    cerrarModal(overlay.querySelector('.modal-close-btn'));
                }
            });
        }

        // Funci√≥n para cerrar modal
        function cerrarModal(boton) {
            const overlay = boton.closest('.modal-overlay');
            if (overlay) {
                overlay.remove();
            }
        }

        // Funci√≥n para ver asignaciones
        function verAsignaciones() {
            console.log('üìã Mostrando tabla de asignaciones');
            console.log('üìä Total de asignaciones:', asignaciones.length);

            if (asignaciones.length === 0) {
                alert('No hay asignaciones para mostrar. Primero selecciona puntos en el mapa y asigna cuadrillas o efectivos.');
                return;
            }

            // Crear ventana nueva con la tabla
            const ventanaAsignaciones = window.open('', '_blank', 'width=1000,height=600,scrollbars=yes');

            const htmlTabla = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Tabla de Asignaciones</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
                    <style>
                        body { padding: 20px; background-color: #f8f9fa; }
                        .table-container { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                        .table th { background-color: #3b82f6; color: white; }
                        .badge { font-size: 0.8em; }
                    </style>
                </head>
                <body>
                    <div class="container-fluid">
                        <div class="table-container">
                            <h2 class="mb-4"><i class="fas fa-clipboard-list"></i> Tabla de Asignaciones</h2>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Punto</th>
                                            <th>Coordenadas</th>
                                            <th>Cuadrilla</th>
                                            <th>Efectivo</th>
                                            <th>Fecha Asignaci√≥n</th>
                                            <th>Estado</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${asignaciones.map(asignacion => `
                                            <tr>
                                                <td><span class="badge bg-primary">${asignacion.id}</span></td>
                                                <td><strong>${DOMPurify.sanitize(asignacion.puntoNombre)}</strong></td>
                                                <td><small class="text-muted">${DOMPurify.sanitize(asignacion.coordenadas)}</small></td>
                                                <td>${asignacion.cuadrilla ? `<i class="fas fa-users text-success"></i> ${DOMPurify.sanitize(asignacion.cuadrilla.nombre)}` : '<span class="text-muted">Sin asignar</span>'}</td>
                                                <td>${asignacion.efectivo ? `<i class="fas fa-shield-alt text-primary"></i> ${DOMPurify.sanitize(asignacion.efectivo.nombre)}` : '<span class="text-muted">Sin asignar</span>'}</td>
                                                <td><small>${asignacion.fechaAsignacion}</small></td>
                                                <td><span class="badge bg-success">${asignacion.estado}</span></td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-secondary" onclick="window.close()">
                                    <i class="fas fa-times"></i> Cerrar
                                </button>
                                <button class="btn btn-primary ms-2" onclick="window.print()">
                                    <i class="fas fa-print"></i> Imprimir
                                </button>
                            </div>
                        </div>
                    </div>
                </body>
                </html>
            `;

            ventanaAsignaciones.document.write(htmlTabla);
            ventanaAsignaciones.document.close();
        }

        // Funci√≥n para guardar asignaci√≥n
        function guardarAsignacion() {
            console.log('üíæ Funci√≥n guardarAsignacion llamada');
            console.log('üìä Puntos seleccionados:', puntosSeleccionados);
            console.log('üìã Asignaciones actuales:', asignaciones);

            // Verificar si hay puntos seleccionados
            if (puntosSeleccionados.length === 0) {
                console.log('‚ùå No hay puntos seleccionados');
                mostrarResultado('No hay puntos seleccionados para guardar asignaci√≥n', 'danger');
                alert('Por favor, selecciona al menos un punto en el mapa antes de guardar la asignaci√≥n.');
                return;
            }

            // Verificar si hay asignaciones realizadas
            if (asignaciones.length === 0) {
                console.log('‚ùå No hay asignaciones realizadas');
                mostrarResultado('No hay asignaciones para guardar', 'danger');
                alert('Por favor, asigna cuadrillas o efectivos a los puntos seleccionados antes de guardar.');
                return;
            }

            console.log('‚úÖ Validaciones pasadas, procediendo a guardar...');

            // Simular guardado de asignaciones
            const timestamp = new Date().toLocaleString();
            const datosGuardado = {
                fecha: timestamp,
                totalPuntos: puntosSeleccionados.length,
                totalAsignaciones: asignaciones.length,
                asignaciones: asignaciones.map(asig => ({
                    id: asig.id,
                    puntoId: asig.puntoId,
                    puntoNombre: asig.puntoNombre,
                    coordenadas: asig.coordenadas,
                    cuadrilla: asig.cuadrilla,
                    efectivo: asig.efectivo,
                    efectivos: asig.efectivos, // Nueva propiedad para m√∫ltiples efectivos
                    fechaAsignacion: asig.fechaAsignacion,
                    estado: asig.estado
                }))
            };

            // Guardar en localStorage para persistencia
            try {
                localStorage.setItem('asignaciones_guardadas', JSON.stringify(datosGuardado));
                console.log('‚úÖ Asignaciones guardadas en localStorage:', datosGuardado);

                // Agrupar asignaciones por punto para una presentaci√≥n m√°s clara
                const asignacionesPorPunto = {};

                // Primero, agrupar todas las asignaciones por punto
                asignaciones.forEach(asig => {
                    const puntoNombre = asig.puntoNombre || `Punto ${asig.puntoId + 1}`;
                    if (!asignacionesPorPunto[puntoNombre]) {
                        asignacionesPorPunto[puntoNombre] = {
                            cuadrillas: new Set(),
                            efectivos: new Set()
                        };
                    }

                    // Agrupar cuadrillas
                    if (asig.cuadrilla) {
                        asignacionesPorPunto[puntoNombre].cuadrillas.add(asig.cuadrilla.nombre);
                    }

                    // Agrupar efectivos individuales
                    if (asig.efectivo) {
                        asignacionesPorPunto[puntoNombre].efectivos.add(asig.efectivo.nombre);
                    }

                    // Agrupar m√∫ltiples efectivos
                    if (asig.efectivos && asig.efectivos.length > 0) {
                        asig.efectivos.forEach(ef => {
                            asignacionesPorPunto[puntoNombre].efectivos.add(ef.nombre);
                        });
                    }
                });

                // Convertir Sets a Arrays para facilitar el manejo
                Object.keys(asignacionesPorPunto).forEach(punto => {
                    asignacionesPorPunto[punto].cuadrillas = Array.from(asignacionesPorPunto[punto].cuadrillas);
                    asignacionesPorPunto[punto].efectivos = Array.from(asignacionesPorPunto[punto].efectivos);
                });

                // Debug: Mostrar el estado de las asignaciones agrupadas
                console.log('üîç DEBUG - Asignaciones originales:', asignaciones);
                console.log('üîç DEBUG - Asignaciones agrupadas por punto:', asignacionesPorPunto);

                // Crear mensajes agrupados por punto
                let mensajesAsignacion = [];
                Object.keys(asignacionesPorPunto).forEach(punto => {
                    const asignacion = asignacionesPorPunto[punto];
                    let recursos = [];

                    if (asignacion.cuadrillas.length > 0) {
                        recursos.push(`üë• Cuadrilla responsable: ${asignacion.cuadrillas.join(', ')}`);
                    }

                    if (asignacion.efectivos.length > 0) {
                        recursos.push(`üöî Efectivos de apoyo (${asignacion.efectivos.length}): ${asignacion.efectivos.join(', ')}`);
                    }

                    mensajesAsignacion.push(`üìç <strong>${punto}</strong><br>&nbsp;&nbsp;&nbsp;${recursos.join('<br>&nbsp;&nbsp;&nbsp;')}`);
                });

                mostrarResultado(`Asignaciones guardadas exitosamente: ${Object.keys(asignacionesPorPunto).length} trabajos asignados`, 'success');

                // Mostrar confirmaci√≥n detallada con trabajos espec√≠ficos
                const contenidoModal = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 48px; margin-bottom: 10px;">‚úÖ</div>
                        <div style="font-size: 16px; color: #16a34a; font-weight: bold;">Asignaciones Completadas</div>
                    </div>
                    
                    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        ${mensajesAsignacion.map(msg => `<div style="margin-bottom: 8px;">${msg}</div>`).join('')}
                    </div>
                    
                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 10px;">üìã RESUMEN:</div>
                        <div>‚Ä¢ <strong>Fecha:</strong> ${timestamp}</div>
                        <div>‚Ä¢ <strong>Trabajos asignados:</strong> ${Object.keys(asignacionesPorPunto).length}</div>
                        <div>‚Ä¢ <strong>Cuadrillas responsables:</strong> ${[...new Set(Object.values(asignacionesPorPunto).flatMap(punto => punto.cuadrillas))].length}</div>
                        <div>‚Ä¢ <strong>Efectivos de apoyo:</strong> ${[...new Set(Object.values(asignacionesPorPunto).flatMap(punto => punto.efectivos))].length}</div>
                        <div>‚Ä¢ <strong>Estado:</strong> Guardado en sistema local</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; color: #16a34a; font-weight: bold;">
                        ¬°Las asignaciones han sido registradas correctamente!
                    </div>
                `;

                mostrarModalCentrado('Confirmaci√≥n de Asignaciones', contenidoModal);

                // Opcional: Limpiar selecciones despu√©s de guardar
                // puntosSeleccionados = [];
                // asignaciones = [];
                // actualizarMenuPuntos();

            } catch (error) {
                console.error('‚ùå Error al guardar asignaciones:', error);
                mostrarResultado('Error al guardar asignaciones', 'danger');
                alert('Error al guardar las asignaciones. Por favor, int√©ntalo de nuevo.');
            }
        }

        // Funci√≥n de debug para verificar clicks
        function debugClick(elemento, accion) {
            console.log('üñ±Ô∏è Click detectado en:', elemento, 'Acci√≥n:', accion);
        }

        // Funci√≥n para cargar datos desde localStorage (cuando se viene desde gesti√≥n de operaciones)
        function cargarDatosDesdeGestion() {
            try {
                const gestionData = localStorage.getItem('gestionData');
                const gestionHeaders = localStorage.getItem('gestionHeaders');

                if (gestionData && gestionHeaders) {
                    const datos = JSON.parse(gestionData);
                    const headers = JSON.parse(gestionHeaders);

                    console.log('üìä Datos cargados desde gesti√≥n:', datos.length, 'registros');
                    console.log('üìä Columnas disponibles:', headers);

                    // Procesar y mostrar los datos en el mapa
                    procesarDatosOperaciones(datos, headers);

                    // Mostrar notificaci√≥n
                    mostrarResultado(`Datos cargados: ${datos.length} registros de operaciones`, 'success');

                    // Limpiar localStorage despu√©s de cargar
                    localStorage.removeItem('gestionData');
                    localStorage.removeItem('gestionHeaders');
                    localStorage.removeItem('timestamp');

                    return true;
                }
            } catch (error) {
                console.error('‚ùå Error al cargar datos desde gesti√≥n:', error);
            }
            return false;
        }

        // Funci√≥n para agregar un punto al mapa
        function agregarPuntoAlMapa(punto) {
            const marcador = L.marker([punto.lat, punto.lng])
                .addTo(mapa)
                .bindPopup(`<strong>${punto.nombre}</strong><br>${punto.ubicacion}<br><small>Datos: ${punto.datosOriginales || 'N/A'}</small>`);

            marcador.puntoData = punto;
            marcador.indice = marcadoresEnMapa.length;

            marcador.on('click', function () {
                seleccionarMarcador(this);
            });

            // Agregar a la lista de marcadores
            marcadoresEnMapa.push(marcador);

            console.log('üìç Punto agregado al mapa:', punto.nombre, 'en', punto.ubicacion);

            return marcador;
        }

        // Funci√≥n para procesar datos de operaciones y crear puntos en el mapa
        function procesarDatosOperaciones(datos, headers) {
            // Buscar columnas que puedan contener informaci√≥n geogr√°fica
            const columnasGeo = headers.filter(header =>
                header.toLowerCase().includes('distrito') ||
                header.toLowerCase().includes('ubicacion') ||
                header.toLowerCase().includes('direccion') ||
                header.toLowerCase().includes('zona') ||
                header.toLowerCase().includes('coordenada')
            );

            console.log('üó∫Ô∏è Columnas geogr√°ficas detectadas:', columnasGeo);

            if (columnasGeo.length > 0) {
                // Usar la primera columna geogr√°fica encontrada
                const columnaGeo = columnasGeo[0];
                const indiceColumna = headers.indexOf(columnaGeo);

                // Crear puntos basados en los datos
                crearPuntosDesdeOperaciones(datos, headers, indiceColumna, columnaGeo);
            } else {
                // Si no hay columnas geogr√°ficas, crear puntos de ejemplo basados en los distritos mencionados
                crearPuntosEjemploOperaciones(datos);
            }
        }

        // Funci√≥n para crear puntos desde datos de operaciones
        function crearPuntosDesdeOperaciones(datos, headers, indiceColumna, nombreColumna) {
            const puntosCreados = new Map();

            datos.forEach((fila, index) => {
                const valorUbicacion = fila[indiceColumna];
                if (valorUbicacion && valorUbicacion.trim()) {
                    // Generar coordenadas basadas en la ubicaci√≥n (simuladas para demo)
                    const coordenadas = generarCoordenadasPorUbicacion(valorUbicacion);

                    if (!puntosCreados.has(valorUbicacion)) {
                        const punto = {
                            id: puntosCreados.size + 1,
                            nombre: `Operaci√≥n ${valorUbicacion}`,
                            lat: coordenadas.lat,
                            lng: coordenadas.lng,
                            descripcion: `Punto de operaci√≥n en ${valorUbicacion}`,
                            datos: fila,
                            headers: headers
                        };

                        puntosCreados.set(valorUbicacion, punto);
                        agregarPuntoAlMapa(punto);
                    }
                }
            });

            console.log('üìç Puntos creados desde operaciones:', puntosCreados.size);
        }

        // Funci√≥n para generar coordenadas basadas en ubicaci√≥n
        function generarCoordenadasPorUbicacion(ubicacion) {
            // Coordenadas base para diferentes distritos/zonas (ejemplo para Lima, Per√∫)
            const coordenadasBase = {
                'VILLA MARIA': { lat: -12.0719, lng: -77.0061 },
                'SAN JUAN DE LURIGANCHO': { lat: -11.9719, lng: -76.9961 },
                'VILLA EL SALVADOR': { lat: -12.2119, lng: -76.9361 },
                'SAN MARTIN DE PORRES': { lat: -11.8819, lng: -77.0761 },
                'COMAS': { lat: -11.9319, lng: -77.0561 }
            };

            // Buscar coincidencia exacta o parcial
            const ubicacionUpper = ubicacion.toUpperCase();
            for (const [distrito, coords] of Object.entries(coordenadasBase)) {
                if (ubicacionUpper.includes(distrito)) {
                    // Agregar variaci√≥n aleatoria peque√±a para evitar superposici√≥n
                    return {
                        lat: coords.lat + (Math.random() - 0.5) * 0.01,
                        lng: coords.lng + (Math.random() - 0.5) * 0.01
                    };
                }
            }

            // Coordenadas por defecto (centro de Lima) con variaci√≥n aleatoria
            return {
                lat: -12.0464 + (Math.random() - 0.5) * 0.1,
                lng: -77.0428 + (Math.random() - 0.5) * 0.1
            };
        }

        // Funci√≥n para crear puntos de ejemplo cuando no hay datos geogr√°ficos espec√≠ficos
        function crearPuntosEjemploOperaciones(datos) {
            const cantidadPuntos = Math.min(datos.length, 10); // M√°ximo 10 puntos

            for (let i = 0; i < cantidadPuntos; i++) {
                const punto = {
                    id: i + 1,
                    nombre: `Operaci√≥n ${i + 1}`,
                    lat: -12.0464 + (Math.random() - 0.5) * 0.1,
                    lng: -77.0428 + (Math.random() - 0.5) * 0.1,
                    descripcion: `Punto de operaci√≥n basado en registro ${i + 1}`,
                    datos: datos[i],
                    headers: ['Registro', 'Datos']
                };

                agregarPuntoAlMapa(punto);
            }

            console.log('üìç Puntos de ejemplo creados:', cantidadPuntos);
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            console.log('üöÄ P√°gina de prueba cargada');

            // Verificar si hay datos desde gesti√≥n de operaciones
            const datosDesdeGestion = cargarDatosDesdeGestion();

            if (datosDesdeGestion) {
                mostrarResultado('Datos de operaciones cargados correctamente', 'success');
            } else {
                mostrarResultado('P√°gina de prueba inicializada correctamente', 'info');
            }

            // Agregar listeners de debug a todos los elementos dropdown
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('click', function (e) {
                    console.log('üñ±Ô∏è Click en dropdown item:', this.textContent.trim());
                    console.log('üñ±Ô∏è Evento:', e);
                });
            });
        });
    </script>
</body>

</html>